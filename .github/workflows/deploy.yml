name: Deploy to Google Cloud

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-south1
  REPO_NAME: ppt-studio-repo
  # Public bucket name for uploads/outputs
  GCS_BUCKET_NAME: ppt-studio-uploads
  PROD_ENV_SECRET_NAME: ppt-studio-prod-env

jobs:
  deploy-backend:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    # This output will be used by the frontend job to get the API URL
    outputs:
      api_url: ${{ steps.store-api-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Pull production environment file from Secret Manager
        run: |
          gcloud secrets versions access latest --secret=${{ env.PROD_ENV_SECRET_NAME }} > .env.production
          echo "APP_ENV=production" >> .env.production

      - name: Validate production compose stack
        run: docker compose -f docker-compose.yml -f docker-compose.prod.yml config

      # ---------------------------
      # Build & Push ONE Backend Image for both API and Worker
      # ---------------------------
      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile # Using the single, consolidated Dockerfile
          push: true
          tags: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/ppt-studio-backend:${{ github.sha }}

      # ---------------------------
      # Deploy API Service from the Backend Image
      # ---------------------------
      - name: Deploy API Service
        run: |
          REDIS_URL="redis://$(gcloud redis instances describe ppt-studio-redis --region=${{ env.GCP_REGION }} --format='value(host)'):6379/0"
          gcloud run deploy ppt-studio-api \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/ppt-studio-backend:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --vpc-connector=vpc-connector \
            --set-env-vars="REDIS_URL=$REDIS_URL,GCS_BUCKET_NAME=${{ env.GCS_BUCKET_NAME }},GOOGLE_CLOUD_STORAGE_USE_GRPC=false,APP_ENV=production" \
            --set-secrets="GOOGLE_API_KEY=gemini-api-key:latest" \
            --command="uvicorn" \
            --args="app.main:app,--host,0.0.0.0,--port,8080"

      - name: Store API URL for Frontend Job
        id: store-api-url
        run: echo "url=$(gcloud run services describe ppt-studio-api --platform=managed --region=${{ env.GCP_REGION }} --format='value(status.url)')" >> $GITHUB_OUTPUT

      # Ensure the API's runtime service account can sign V4 URLs and read objects
      - name: Grant API runtime SA permissions
        run: |
          API_SA=$(gcloud run services describe ppt-studio-api --region=${{ env.GCP_REGION }} --format='value(spec.template.spec.serviceAccountName)')
          echo "API runtime SA: $API_SA"
          # Allow reading objects from the bucket
          gsutil iam ch serviceAccount:${API_SA}:roles/storage.objectViewer gs://${{ env.GCS_BUCKET_NAME }} || true
          # Allow signing URLs (signBlob)
          gcloud iam service-accounts add-iam-policy-binding "$API_SA" \
            --member="serviceAccount:$API_SA" \
            --role="roles/iam.serviceAccountTokenCreator" || true

      # ---------------------------
      # Deploy Worker Service from the SAME Backend Image
      # ---------------------------
      - name: Deploy Worker Service
        run: |
          REDIS_URL="redis://$(gcloud redis instances describe ppt-studio-redis --region=${{ env.GCP_REGION }} --format='value(host)'):6379/0"
          gcloud run deploy ppt-studio-worker \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/ppt-studio-backend:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --no-allow-unauthenticated \
            --vpc-connector=vpc-connector \
            --set-env-vars="REDIS_URL=$REDIS_URL,GCS_BUCKET_NAME=${{ env.GCS_BUCKET_NAME }},GOOGLE_CLOUD_STORAGE_USE_GRPC=false,APP_ENV=production" \
            --set-secrets="GOOGLE_API_KEY=gemini-api-key:latest" \
            --no-cpu-throttling \
            --min-instances=1 \
            --command="/app/worker_entrypoint.sh" # Use absolute path for reliability


  deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend # This ensures the backend is deployed first and the API URL is available

    # Set environment variable for this job from the backend job's output
    env:
      VITE_API_URL: ${{ needs.deploy-backend.outputs.api_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./frontend
      
      # This is a cleaner way to provide the API URL to your Vite app
      - name: Create .env file for Frontend
        run: |
          echo "VITE_API_URL=${{ env.VITE_API_URL }}" > .env.production
        working-directory: ./frontend
      
      - name: Build React App
        run: npm run build
        working-directory: ./frontend
        
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}'
          projectId: ${{ env.GCP_PROJECT_ID }}
          entryPoint: ./frontend
          channelId: live
